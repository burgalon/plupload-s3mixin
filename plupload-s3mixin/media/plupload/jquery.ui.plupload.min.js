(function(d){var e={},c;function a(f){return plupload.translate(f)||f}function b(f){f.prepend('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="plupload"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_header_title">'+a("Select files")+'</div><div class="plupload_header_text">'+a("Add files to the upload queue and click the start button.")+'</div></div></div><div class="plupload_content"><table class="plupload_filelist"><tr class="ui-widget-header plupload_filelist_header"><td class="plupload_cell plupload_file_name">'+a("Filename")+'</td><td class="plupload_cell plupload_file_status">'+a("Status")+'</td><td class="plupload_cell plupload_file_size">'+a("Size")+'</td><td class="plupload_cell plupload_file_action">&nbsp;</td></tr></table><div class="plupload_scroll"><table class="plupload_filelist_content"></table></div><table class="plupload_filelist"><tr class="ui-widget-header ui-widget-content plupload_filelist_footer"><td class="plupload_cell plupload_file_name"><div class="plupload_buttons"><!-- Visible --><a class="plupload_button plupload_add">'+a("Add Files")+'</a>&nbsp;<a class="plupload_button plupload_start">'+a("Start Upload")+'</a>&nbsp;<a class="plupload_button plupload_stop plupload_hidden">'+a("Stop Upload")+'</a>&nbsp;</div><div class="plupload_started plupload_hidden"><!-- Hidden --><div class="plupload_progress plupload_right"><div class="plupload_progress_container"></div></div><div class="plupload_cell plupload_upload_status"></div><div class="plupload_clearer">&nbsp;</div></div></td><td class="plupload_file_status"><span class="plupload_total_status">0%</span></td><td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td><td class="plupload_file_action"></td></tr></table></div></div></div><input class="plupload_count" value="0" type="hidden"></div>')}d.widget("ui.plupload",{contents_bak:"",runtime:null,options:{dragdrop:true,browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",buttons:{browse:true,start:true,stop:true},autostart:false,sortable:false,rename:false,max_file_count:0},FILE_COUNT_ERROR:-9001,_create:function(){var f=this,h,g;h=this.element.attr("id");if(!h){h=plupload.guid();this.element.attr("id",h)}this.id=h;this.contents_bak=this.element.html();b(this.element);this.container=d(".plupload_container",this.element).attr("id",h+"_container");this.filelist=d(".plupload_filelist_content",this.container).attr("id",h+"_filelist");this.browse_button=d(".plupload_add",this.container).attr("id",h+"_browse");this.start_button=d(".plupload_start",this.container).attr("id",h+"_start");this.stop_button=d(".plupload_stop",this.container).attr("id",h+"_stop");if(d.ui.button){this.browse_button.button({icons:{primary:"ui-icon-circle-plus"}});this.start_button.button({icons:{primary:"ui-icon-circle-arrow-e"},disabled:true});this.stop_button.button({icons:{primary:"ui-icon-circle-close"}})}if(!this.options.buttons.browse){this.browse_button.button("disable").hide();d("#"+h+f.runtime+"_container").hide()}if(!this.options.buttons.start){this.start_button.button("disable").hide()}if(!this.options.buttons.stop){this.stop_button.button("disable").hide()}this.progressbar=d(".plupload_progress_container",this.container);if(d.ui.progressbar){this.progressbar.progressbar()}this.counter=d(".plupload_count",this.element).attr({id:h+"_count",name:h+"_count"});g=this.uploader=e[h]=new plupload.Uploader(d.extend({container:h,browse_button:h+"_browse"},this.options));g.bind("Init",function(i,j){(!f.options.unique_names&&f.options.rename&&f._enableRenaming());(g.features.dragdrop&&f.options.dragdrop&&f._enableDragAndDrop());f.container.attr("title",a("Using runtime: ")+(f.runtime=j.runtime));f.start_button.click(function(k){if(!d(this).button("option","disabled")){f.start()}k.preventDefault()});f.stop_button.click(function(k){g.stop();k.preventDefault()})});if(f.options.max_file_count){g.bind("FilesAdded",function(i,k){var j=k.length,l=[];if(j>f.options.max_file_count){l=k.splice(f.options.max_file_count);i.trigger("Error",{code:f.FILE_COUNT_ERROR,message:a("File count error."),file:l})}})}g.init();g.bind("FilesAdded",function(i,j){f._trigger("selected",null,{up:i,files:j});if(f.options.autostart){f.start()}});g.bind("FilesRemoved",function(i,j){f._trigger("removed",null,{up:i,files:j})});g.bind("QueueChanged",function(){f._updateFileList()});g.bind("StateChanged",function(){f._handleState()});g.bind("UploadFile",function(i,j){f._handleFileStatus(j)});g.bind("FileUploaded",function(i,j){f._handleFileStatus(j);f._trigger("uploaded",null,{up:i,file:j})});g.bind("UploadProgress",function(i,j){d("#"+j.id+" .plupload_file_status",f.element).html(j.percent+"%");f._handleFileStatus(j);f._updateTotalProgress();f._trigger("progress",null,{up:i,file:j})});g.bind("UploadComplete",function(i,j){f._trigger("complete",null,{up:i,files:j})});g.bind("Error",function(i,m){var k=m.file,l,j;if(k){l="<strong>"+m.message+"</strong>";j=m.details;if(j){l+=" <br /><i>"+m.details+"</i>"}else{switch(m.code){case plupload.FILE_EXTENSION_ERROR:j=a("File: %s").replace("%s",k.name);break;case plupload.FILE_SIZE_ERROR:j=a("File: %f, size: %s, max file size: %m").replace(/%([fsm])/g,function(o,n){switch(n){case"f":return k.name;case"s":return k.size;case"m":return plupload.parseSize(f.options.max_file_size)}});break;case f.FILE_COUNT_ERROR:j=a("Upload element accepts only %d file(s) at a time. Extra files were stripped.").replace("%d",f.options.max_file_count);break;case plupload.HTTP_ERROR:j=a("Upload URL might be wrong or doesn't exist");break}l+=" <br /><i>"+j+"</i>"}f._notify("error",l)}})},start:function(){this.uploader.start();this._trigger("start",null)},stop:function(){this.uploader.stop();this._trigger("stop",null)},getFile:function(g){var f;if(typeof g==="number"){f=this.uploader.files[g]}else{f=this.uploader.getFile(g)}return f},removeFile:function(g){var f=this.getFile(g);if(f){this.uploader.removeFile(f)}},clearQueue:function(){this.uploader.splice()},_handleState:function(){var f=this,g=this.uploader;if(g.state===plupload.STARTED){d(f.start_button).button("disable");d([]).add(f.stop_button).add(".plupload_started").removeClass("plupload_hidden");d(".plupload_upload_status",f.element).text(a("Uploaded %d/%d files").replace("%d/%d",g.total.uploaded+"/"+g.files.length));d(".plupload_header_content",f.element).addClass("plupload_header_content_bw")}else{d([]).add(f.stop_button).add(".plupload_started").addClass("plupload_hidden");if(f.options.multiple_queues){d(f.start_button).button("enable");d(".plupload_header_content",f.element).removeClass("plupload_header_content_bw");f._updateFileList()}}},_handleFileStatus:function(i){var k,g;switch(i.status){case plupload.DONE:k="plupload_done";g="ui-icon ui-icon-circle-check";break;case plupload.FAILED:k="ui-state-error plupload_failed";g="ui-icon ui-icon-alert";break;case plupload.QUEUED:k="plupload_delete";g="ui-icon ui-icon-circle-minus";break;case plupload.UPLOADING:k="ui-state-highlight plupload_uploading";g="ui-icon ui-icon-circle-arrow-w";var f=d(".plupload_scroll",this.container),j=f.scrollTop(),l=f.height(),h=d("#"+i.id).position().top+d("#"+i.id).height();if(l<h){f.scrollTop(j+h-l)}break}k+=" ui-state-default plupload_file";d("#"+i.id).attr("class",k).find(".ui-icon").attr("class",g)},_updateTotalProgress:function(){var f=this.uploader;this.progressbar.progressbar("value",f.total.percent);d(".plupload_total_status",this.element).html(f.total.percent+"%");d(".plupload_upload_status",this.element).text(a("Uploaded %d/%d files").replace("%d/%d",f.total.uploaded+"/"+f.files.length));if(f.total.uploaded==f.files.length){f.stop()}},_updateFileList:function(){var g=this,k=this.uploader,i=this.filelist,h=0,j=this.id+"_",f;(d.ui.sortable&&this.options.sortable&&d("tbody",i).sortable("destroy"));i.empty();d.each(k.files,function(m,l){f="";id=j+h;if(l.status==plupload.DONE){if(l.target_name){f+='<input type="hidden" name="'+id+'_tmpname" value="'+plupload.xmlEncode(l.target_name)+'" />'}f+='<input type="hidden" name="'+id+'_name" value="'+plupload.xmlEncode(l.name)+'" />';f+='<input type="hidden" name="'+id+'_status" value="'+(l.status==plupload.DONE?"done":"failed")+'" />';h++;g.counter.val(h)}i.append('<tr class="ui-state-default plupload_file" id="'+l.id+'"><td class="plupload_cell plupload_file_name"><span>'+l.name+'</span></td><td class="plupload_cell plupload_file_status">'+l.percent+'%</td><td class="plupload_cell plupload_file_size">'+plupload.formatSize(l.size)+'</td><td class="plupload_cell plupload_file_action"><div class="ui-icon"></div>'+f+"</td></tr>");g._handleFileStatus(l);d("#"+l.id+".plupload_delete .ui-icon, #"+l.id+".plupload_done .ui-icon").click(function(n){d("#"+l.id).remove();k.removeFile(l);n.preventDefault()})});d(".plupload_total_file_size",g.element).html(plupload.formatSize(k.total.size));if(k.total.queued===0){d(".ui-button-text",g.browse_button).text(a("Add Files"))}else{d(".ui-button-text",g.browse_button).text(a("%d files queued").replace("%d",k.total.queued))}if(k.files.length==(k.total.uploaded+k.total.failed)){g.start_button.button("disable")}else{g.start_button.button("enable")}i[0].scrollTop=i[0].scrollHeight;g._updateTotalProgress();if(!k.files.length&&k.features.dragdrop&&k.settings.dragdrop){d("#"+id+"_filelist").append('<tr><td class="plupload_droptext">'+a("Drag files here.")+"</td></tr>")}else{(g.options.sortable&&d.ui.sortable&&g._enableSortingList())}},_enableRenaming:function(){var f=this;d(".plupload_file_name span",this.filelist).live("click",function(l){var j=d(l.target),h,k,g,i="";h=f.uploader.getFile(j.parents("tr")[0].id);g=h.name;k=/^(.+)(\.[^.]+)$/.exec(g);if(k){g=k[1];i=k[2]}j.hide().after('<input class="plupload_file_rename" type="text" />');j.next().val(g).focus().blur(function(){j.show().next().remove()}).keydown(function(n){var m=d(this);if(d.inArray(n.keyCode,[13,27])!==-1){n.preventDefault();if(n.keyCode==13){h.name=m.val()+i;j.text(h.name)}m.blur()}})})},_enableDragAndDrop:function(){this.filelist.append('<tr><td class="plupload_droptext">'+a("Drag files here.")+"</td></tr>");this.filelist.parent().attr("id",this.id+"_dropbox");this.uploader.settings.drop_element=this.options.drop_element=this.id+"_dropbox"},_enableSortingList:function(){var g,f=this;if(d("tbody tr",this.filelist).length<2){return}d("tbody",this.filelist).sortable({containment:"parent",items:".plupload_delete",helper:function(i,h){return h.clone(true).find("td:not(.plupload_file_name)").remove().end().css("width","100%")},start:function(i,h){g=d("tr",this).index(h.item)},stop:function(o,n){var h,m=[],l=d("tr",this).index(n.item);for(var j=0,k=f.uploader.files.length;j<k;j++){if(j==l){h=g}else{if(j==g){h=l}else{h=j}}m[m.length]=f.uploader.files[h]}m.unshift(m.length);m.unshift(0);Array.prototype.splice.apply(f.uploader.files,m)}})},_notify:function(g,h){var f=d('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+a("Close")+'"></span><p><span class="ui-icon"></span>'+h+"</p></div>");f.addClass("ui-state-"+(g=="error"?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+(g=="error"?"alert":"info")).end().find(".plupload_message_close").click(function(){f.remove()}).end().appendTo(".plupload_header_content",this.container)},getUploader:function(){return this.uploader},destroy:function(){d(".plupload_button",this.element).unbind();(d.ui.button&&d(".plupload_add, .plupload_start, .plupload_stop",this.container).button("destroy"));(d.ui.progressbar&&this.progressbar.progressbar("destroy"));(d.ui.sortable&&this.options.sortable&&d("tbody",this.filelist).sortable("destroy"));this.uploader.destroy();this.element.empty().html(this.contents_bak);this.contents_bak="";d.Widget.prototype.destroy.apply(this)}})})(jQuery);